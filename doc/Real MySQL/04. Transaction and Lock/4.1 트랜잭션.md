- 트랜잭션은 작업의 완전성을 보장해주는 것이다.
- 논리적인 작업을 모두 완벽하게 처리하거나 또는 처리하지 못할 경우에는 원 상태로 복구해서 작업의 일부분만 적용되는 현상이 발생하지 않게 만들어주는 기능이다.
- 잠금과 트랜잭션은 서로 비슷한 개념같지만 잠금은 동시성을 제어하기 위한 기능이고 트랜잭션은 데이터의 정합성을 보장하기 위한 기능이다.
- 잠금은 여러 커넥션에서 동시에 동일한 자원을 요청할 경우 순서대로 한 시점에서 하나의 커넥션만 변경할 수 있게 해주는 역하을 한다.
- 격리 수준이라는 것은 하나의 트랜잭션 내에서 또는 여러 트랜잭션 간의 작업 내용을 어떻게 공유하고 차단할 것이인지를 결정하는 레벨을 의미한다.

<br>

# 4.1 트랜잭션

- 트랜잭션을 지원하지 않는 MyISAM 스토리지 엔진과 트랜잭션을 지원하는 InnoDB 스토리지 엔진의 처리 방식의 차이를 살펴본다.

<br>

## 4.1.1 MySQL에서의 트랜잭션

- 트랜잭션은 논리적인 작업들이 `COMMIT` 되었을 때 모두 적용되거나 `ROLLBACK` 되었을 때 아무것도 적용되지 않는 것을 보장해주는 것이다.
- 기본키의 중복을 허용하지 않는 테이블에 기존의 기본키가 3인 값이 저장되어있다. 이 때 MyISAM과 InnoDB 스토리지 엔진에 각각 중복된 데이터를 넣었을 때의 결과를 확인해보자.
    - `INSERT INTO table (pk) VALUES(1), (2), (3)`
    - MyISAM과 InnoDB 모두 기본키 중복 오류로 쿼리가 실패했지만 두 테이블의 레코드를 조회해보면 다른 결과가 나타남을 확인할 수 있다.
    - MyISAM의 경우 앞의 `1` 과 `2` 레코드를 삽입한 결과가 반영된 반면에 InnoDB 에서는 작업 전체를 `ROLLBACK` 해서 적용되지 않은 것을 확인할 수 있다.
- MyISAM에서 발생하는 이러한 현상을 부분 업데이트 (Partial Update)라고 표현하며 이와 같은 문제는 데이터 테이블의 정합성을 맞추는데 상당히 어려운 문제를 만든다.
- 반면에 InnoDB 스토리지 엔진은 쿼리 중 일부라도 오류가 발생하면 쿼리 문장을 실행하기 전 상태로 복구한다.
- 트랜잭션은 애플리케이션 개발에서 부분 업데이트와 같은 문제로 인한 데이터 정합성에 대한 고민을 상당히 줄여주는 필수적인 DBMS의 기능이다.
- 부분 업데이트가 발생하면 실패한 쿼리로 인한 레코드를 다시 삭제하는 재처리 작업이 필요해질 수도 있다.
- 실행한 쿼리가 하나 뿐이라면 재처리 작업이 간단하지만 둘 이상의 쿼리가 실행되는 경우라면 재처리 작업은 상당한 고민거리로 작용할 것이다.

<br>

> 정리

- 트랜잭션은 논리적인 작업을 모두 완벽하게 처리하거나 또는 처리하지 못할 경우에는 원 상태로 복구해서 작업의 일부분만 적용되는 현상이 발생하지 않게 만들어주는 기능이다.
- MyISAM 스토리지 엔진은 트랜잭션을 지원하지 않기 때문에 부분 업데이트와 같은 문제가 발생할 수 있으며 이는 데이터 정합성 문제를 발생시킬 뿐만 아니라 쿼리를 상당히 복잡하게 만든다.
- 트랜잭션은 애플리케이션 개발에 있어서 이러한 고민들을 줄여주는 DBMS 필수 기능이다.

<br>

## 4.1.2 주의사항

- 트랜잭션 또한 DBMS 커넥션과 동일하게 꼭 필요한 최소의 코드에만 적용하는 것이 좋다.
- 즉, 프로그램 코드에서 트랜잭션의 범위를 최소화하라는 의미이다.
- 일반적으로 데이터베이스의 커넥션 개수는 제한적이기 때문에 각 단위의 프로그램이 커넥션을 소유하는 시간이 길어질수록 사용 가능한 여유 커넥션의 개수는 줄어들 것이다.
- 그리고 어느 순간에는 커넥션을 가져가기 위해 기다려야 하는 상황이 발생할 수도 있다.
- 특히 네트워크를 통해 다른 원격 서버와 통신하는 등과 같은 작업은 어떻게 해서든 DBMS 트랜잭션 내에서 제거하는 것이 좋다.
- 프로그램이 실행되는 동안 다른 서버와 통신할 수 없는 상황이 발생한다면 웹 서버 뿐만 아니라 DBMS 서버까지 위험해지는 상황이 발생할 것이다.
- 이런 실수로 인해 DBMS 서버가 높은 부하 상태로 빠지거나 위험한 상태에 빠지는 경우가 빈번하게 발생하기 때문에 트랜잭션의 범위를 최소화하여 적절한 트랜잭션 범위를 가지는 것이 중요하다.

<br>

> 정리

- 트랜잭션은 꼭 필요한 최소한의 코드에만 적용하여 트랜잭션의 범위를 최소화 하는 것이 좋다.
- 일반적으로 데이터베이스에서의 커넥션 개수는 제한적이기 때문에 커넥션을 소유하는 시간이 길어질 수록 여유 커넥션 개수가 줄어들며 이로 인한 대기 상황이 발생할 수도 있다.
- 특히 다른 서버와 네트워크를 통해 통신하는 작업은 트랜잭션에서 철저히 배제시키는 것이 좋다.
- 네트워크를 통해 통신할 수 없는 상황이 발생한다면 웹 서버는 물론 DBMS 서버까지 부하를 발생시킬 수 있다.
- 때문에 트랜잭션은 범위를 최소화하여 꼭 필요한 경우에만 사용하는 것이 중요하다.
