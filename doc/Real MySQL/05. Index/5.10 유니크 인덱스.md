# 5.10 유니크 인덱스

- 유니크 인덱스란 인덱스라기보다는 제약 조건에 가까운데 테이블이나 인덱스에 같은 값이 중복해서 저장될 수 없다는 것을 의미한다.
- MySQL에서는 인덱스 없이 유니크 제약만 설정할 방법이 없으며 유니크 인덱스에서도 `NULL` 값이 저장될 수 있는데 `NULL` 은 특정 값이 아니므로 2개 이상 저장될 수 있다.
- MySQL에서 기본키는 기본적으로 `NULL` 을 허용하지 않는 유니크 속성이 자동으로 부여된다.
- MyISAM이나 Memory 테이블에서 기본키는 사실 `NULL` 이 허용되지 않는 유니크 인덱스와 같지만 InnoDB 테이블의 기본키는 클러스터 키의 역할도 하기 때문에 유니크 인덱스와는 다르다.

<br>

## 5.10.1 유니크 인덱스와 일반 보조 인덱스의 비교

- 유니크 인덱스와 유니크하지 않은 일반 보조 인덱스는 사실 인덱스의 구조상 아무런 차이점이 없다.
- 유니크 인덱스와 일반 보조 인덱스의 읽기와 쓰기 성능 관점에서 살펴보면 다음과 같다.
    - 인덱스 읽기
        - 유니크 인덱스가 빠르다고 생각하지만 유니크하지 않은 보조 인덱스에서 한번 더 수행해야 하는 작업은 디스크 읽기가 아니라 CPU에서 컬럼의 값을 비교하는 작업이기 때문에 이는 성능상 큰 차이가 없다.
        - 유니크하지 않은 보조 인덱스는 중복을 허용하기 때문에 읽어야할 레코드가 많아져서 느린 것일뿐 인덱스 자체의 특성 때문에 느린 것은 아니다.
        - 하나의 값을 검색하는 경우 유니크 인덱스와 일반 보조 인덱스는 사용되는 실행계획이 다르지만 이는 인덱스의 성격이 유니크한지 아닌지의 차이일 뿐 큰 차이는 없다.
    - 인덱스 쓰기
        - 새로운 레코드가 `INSERT` 되거나 인덱스 컬럼의 값이 변경되는 경우 인덱스 쓰기 작업이 필요하다.
        - 유니크 인덱스의 값을 쓸 때에는 중복값이 존재하는지 아닌지 검사하는 과정이 한 단계 더 필요하기 떄문에 일반 보조 인덱스 쓰기보다 느리다.
        - MySQL에서는 유니크 인덱스에서 중복된 값을 체크할 때 읽기 잠금을 사용하고 쓰기를 할 때에는 쓰기 잠금을 사용하는데 이 과정에서 데드락이 빈번하게 발생한다.
        - 뿐만아니라 InnoDB 스토리지 엔진의 인덱스 키 저장을 버퍼링 하기 위한 인서트 버퍼 같은 경우도 중복을 검사해야하기 때문에 사용할 수 없다.

<br>

> 정리

- 유니크 인덱스와 일반 보조 인덱스는 구조상 아무런 차이가 없지만 인덱스의 읽기와 쓰기 관점에서 살펴보면 차이가 존재한다.
- 유니크하지 않은 일반 보조 인덱스에서 디스크 읽기 작업이 아닌 CPU에서 컬럼의 값을 비교하는 작업만 추가되었기 때문에 성능상 큰 차이는 없다.
- 유니크하지 않은 일반 보조 인덱스에서는 중복을 허용하기 때문에 단순히 읽어야할 레코드가 많기 떄문에 느려진 것일 뿐이지 인덱스를 읽는 자체의 성능은 큰 차이가 없다.
- 반면에 인덱스 쓰기 작업은 유의미한 차이가 존재하는데 유니크 인덱스의 경우 해당 인덱스의 값의 중복값이 존재하는지 여부를 반드시 검사해야하기 떄문이다.
- 특히 유니크 인덱스에서 중복된 값을 검사할 때 읽기 잠금을 사용하고 쓰기를 할 때에 쓰기 잠금을 사용하는데 이러한 과정에서 데드락이 빈번하게 발생한다.
- 또한 유니크 인덱스의 경우에는 중복값을 검사하는 로직을 수행해야하기 때문에 InnoDB 스토리지 엔진에서 제공하는 인서트 버퍼를 사용한 쓰기 버퍼링 기능을 사용할 수 없다.

<br>

## 5.10.2 유니크 인덱스 사용시 주의사항

- 꼭 필요한 경우라면 유니크 인덱스를 생성하는 것이 당연하지만 성능 향상을 기대하고 불필요한 유니크 인덱스를 생성하는 것은 지양해야 한다.
- 하나의 테이블에서 동일한 컬럼에 대해서 유니크 인덱스와 일반 보조 인덱스를 중복해서 선언하는 경우에도 이미 두 인덱스가 동일한 역할을 수행하기 떄문에 불필요한 중복이 발생한다.
- 결론적으로 유일성이 꼭 보장돼야하는 컬럼에 대해서 유니크 인덱스를 생성하되 꼭 필요하지 않다면 유니크 인덱스를 고집할 필요가 없다.

<br>

> 정리

- 유니크 인덱스는 꼭 필요한 경우에 알맞게 사용해야 하며 불필요한 유니크 인덱스 사용은 오히려 성능에 악영향을 미칠 수 있다.
