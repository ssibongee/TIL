# 3.8 MySQL 로그 파일

- MySQL은 다른 상용 DBMS와 비교하면 DBA와 개발자를 위한 진단 도구가 부족한 편이다.
- 하지만 로그 파일을 이용하면 MySQL의 상태나 부하를 일으키는 원인을 찾아서 해결할 수 있다.
- 때문에 MySQL 서버에 문제가 생겼을 때는 각 용도별 로깅 기능이나 로그 파일을 자세히 확인하는 습관이 필요하다.

<br>

## 3.8.1 에러 로그 파일

- MySQL이 실행되는 도중 발생한 에러나 경고 메세지가 출력되는 로그 파일이다.
- MySQL 설정 파일에 `log_error` 라는 이름의 파라미터에 정의된 경로에 존재하거나 별도로 정의하지 않은 경우에는 데이터 디렉토리의 `.err` 확장자가 붙은 파일이다.

<br>

### MySQL 에러 로그 파일의 주요 메세지

- MySQL이 시작하는 과정과 관련된 정보성 및 에러 메세지
- 마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB 트랜잭션 복구 메세지
- 쿼리 도중 발생하는 문제에 대한 에러 메세지
- 비정상적으로 종료된 커넥션 메세지
- InnoDB 모니터링 명령이나 상태 조회 명령의 결과 메세지
- MySQL의 종료 메세지

<br>

## 3.8.2 제너럴 쿼리 로그 파일

- 쿼리 로그 파일에는 시간 단위로 실행됬던 쿼리의 내용이 모두 기록된다.
- 슬로우 쿼리 로그와는 다르게 제너럴 쿼리 로그는 실행되기 전에 MySQL이 쿼리 요청을 받으면 바로 기록하기 때문에 쿼리 실행 중에 에러가 발생해도 일단 로그 파일에 기록된다.
- 설정 파일에서 `general_log_file` 이라는 이름의 파라미터에 정의된 경로에 있는 파일이다.
- MySQL 5.1 이상 버전에서는 쿼리 로그를 파일이 아닌 테이블에 저장할 수 있도록 설정할 수 있으며 이 경우 SQL로 조회해야 한다.

<br>

## 3.8.3 슬로우 쿼리 로그

- MySQL 서버의 쿼리 튜닝은 크게 서비스가 적용되기 전에 전체적으로 튜닝하는 경우와 서비스 운영 중에 서버의 전체적인 성능 저하를 검사하거나 정기적인 점검을 위한 튜닝으로 나눌 수 있다.
- 전자의 경우 검토해야 할 대상 쿼리가 전체 쿼리이기 때문에 모든 쿼리를 튜닝하면 된다.
- 후자의 경우에는 어떤 쿼리가 문제의 쿼리인지 판단하기가 어렵기 때문에 슬로우 쿼리 로그를 활용해야 한다.
- 슬로우쿼리 로그 파일에는 설정 파일에서 정의한 시간 이상의 시간이 소요된 쿼리가 모두 기록된다.
- 슬로우 쿼리 로그는 MySQL이 쿼리를 실행한 다음 실제 소요된 시간을 기준으로 기록할지 여부를 판단하기 때문에 반드시 쿼리가 정상적으로 실행되어야 기록될 수 있다.
- 즉, 슬로우 쿼리에 기록된 쿼리는 일단 정상적으로 실행이 완료되었고 실행하는 걸린 시간이 `long_query_time` 에 정의된 시간보다 많이 걸린 쿼리이다.
- 슬로우 쿼리에 기록된 항목들을 다음과 같다.
    - `Time` : 쿼리가 종료된 시점을 의미한다. 쿼리가 시작된 시각을 구하기 위해서는 `Time` 항목에 나온 시간에서 `Query_time` 만큼을 빼야 한다.
    - `User@Host` : 쿼리를 실행한 사용자의 계정이다.
    - `Query_time` : 쿼리가 실행되는데 걸리 전체 시간을 의미한다.
    - `Lock_time` : MySQL 엔진 레벨에서 관장하는 테이블 잠금에 대한 대기 시간만을 표현한다. `Lock_time` 에 표기된 시간은 실제 쿼리가 실행되는데 필요한 잠금 체크와 같은 코드 실행 부분의 시간까지도 모두 포함하기 때문에 이 값이 매우 작은 값일 경우 무시해도 상관없다.
    - `Rows_examined` : 쿼리가 처리되기 위해 몇 건의 레코드에 접근했는지를 의미한다.
    - `Rows_sent` : 실제 몇 건의 처리 결과를 클라이언트로 보냈는지를 의미한다. `Rows_examined` 의 레코드 건수는 높지만 `Rows_sent` 에 표시된 레코드 건수가 상당히 적다면 적은 레코드만 접근하도록 튜닝해볼 가치가 있다.
- MyISAM이나 Memory 스토리지 엔진에서는 테이블 단위의 잠금을 사용하고 MVCC와 같은 매커니즘이 없기 떄문에 `SELECT` 쿼리라고 하더라도 `Lock_time` 이 1초 이상 소요될 가능성이 있다.

<br>

## 3.8.4 바이너리 로그와 릴레이 로그

- 바이너리 로그 파일은 마스터 MySQL 서버에서 생성되고 릴레이 로그는 슬레이브 MySQL 서버에서 생성된다는 것을 제외하고 해당 로그들의 내용이나 포맷은 동일하다.
- 바이너리 로그에는 순수한 `SELECT` 문장과 같이 데이터의 구조나 내용을 변경하지 않는 쿼리를 기록되지 않는다.
- 바이너리 로그는 이진 파일로 되어있어서 사람의 눈으로 보거나 MySQL 서버에서 바로 실행할 수는 없다.
- 이진 형태의 바이너리 로그를 텍스트 형태로 바꾸려면 MySQL 홈 디렉토리의 `bin` 디렉토리에 있는 `mysqlbinlog` 라는 프로그램을 이용할 수 있다.
- `mysqlbinlog` 는 특정 시간부터 특정 시간까지의 로그 내용을 SQL형태로 읽어서 화면으로 출력하는 일만 할 수 있다.

<br>

> 정리

- MySQL에서는 다른 상용 DBMS보다 진단 도구가 부족하지만 로그 파일을 이용하면 MySQL 상태나 부하를 일으키는 원인을 찾아서 문제를 해결할 수 있다.
- MySQL에서 기록하는 로그들은 에러 로그, 제너럴 쿼리 로그, 슬로우 쿼리 로그, 바이너리 로그와 릴레이 로그 등이 있다.
- 에러 로그는 MySQL이 실행도중 발생한 경고 또는 에러 메세지들이 출력되는 로그 파일이다.
- 제너럴 쿼리 로그는 실행 했던 모든 쿼리를 기록하는 로그 파일로 실행 전에 기록을 하기 때문에 실행 중에 에러가 발생한 쿼리도 기록된다.
- 슬로우 쿼리 로그는 정상적으로 실행 된 쿼리 중에서 `long_query_time` 이상 소요된 쿼리들을 기록하며 서비스 운영중에 성능 저하를 일으키는 쿼리를 발견하고 튜닝하기 위해서 사용된다.
- 바이너리 로그와 릴레이 로그는 데이터의 구조나 내용을 변경하는 쿼리가 기록되며 이진 파일로 되어 있어서 바로 실행하거나 확인할 수는 없다.
- 바이너리 로그를 확인하기 위해서는 `mysqlbinlog` 라는 프로그램을 사용해야 하며 해당 프로그램을 사용하면 특정 시간 사이의 로그 내용을 SQL 형태로 읽어서 출력해준다.
